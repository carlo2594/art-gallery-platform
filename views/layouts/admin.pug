//- views/layouts/admin.pug
doctype html
html(lang='es')
  head
    meta(charset='utf-8')
    meta(name='viewport', content='width=device-width, initial-scale=1')
    title #{title ? title + ' · Admin · Ox Gallery' : 'Admin · Ox Gallery'}
    link(rel='stylesheet', href='/bootstrap/css/bootstrap.min.css')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css')
    link(rel='stylesheet', href='/css/style.css')
    link(rel='stylesheet', href='https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css')
    //- Cargar axios y shim temprano para que inline scripts lo usen
    script(src='https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js')
    script(src='/js/http.js')
  body
    .d-flex.min-vh-100
      //- Sidebar
      aside.admin-sidebar.d-flex.flex-column.flex-shrink-0.p-3
        a.d-flex.align-items-center.mb-3.mb-md-0.me-md-auto.text-decoration-none(href='/')
          img.logo-navbar.me-2(src='/Logos/GOX_LOGO_06.png', alt='Ox Gallery', width='32', height='32')
          span.fs-5.fw-bold.text-uppercase Ox Gallery
        hr
        ul.nav.nav-pills.flex-column.mb-auto
          li.nav-item.mb-2
            a.nav-link.admin-nav-link(href='/admin' aria-current='page')
              i.fas.fa-house.me-2
              | Start
          li.mb-2
            a.nav-link.admin-nav-link(href='/admin/users?role=artist')
              i.fas.fa-user.me-2
              | Artists
          li.mb-2
            a.nav-link.admin-nav-link(href='/admin/collectors')
              i.fas.fa-users.me-2
              | Collectors
          li.mb-2
            a.nav-link.admin-nav-link(href='/admin/artist-applications')
              i.fas.fa-id-card.me-2
              | Artist requests
          li.mb-2
            a.nav-link.admin-nav-link(href='/admin/artworks')
              i.fas.fa-image.me-2
              | Artworks
          li.mb-2
            a.nav-link.admin-nav-link(href='/admin/exhibitions')
              i.fas.fa-landmark.me-2
              | Exhibitions
        hr
        a.btn.btn-outline-primary.ox-back-btn.w-100.mt-auto(href='/' aria-label='Return')
          i.fas.fa-arrow-left.me-2
          | Return

      //- Main content
      main.admin-main.flex-grow-1.p-4
        block content

    // Toast container (Bootstrap)
    .toast-container.position-fixed.top-0.end-0.p-3#admin-toast-container

    script(src='/bootstrap/js/bootstrap.bundle.min.js')
    script(src='https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js')
    script(src='/js/main.js')
    script(src='/js/admin.js')
    // Confirm-delete modal handler
    script.
      (function(){
        document.addEventListener('input', function(e){
          var input = e.target.closest && e.target.closest('.confirm-delete-modal .confirm-delete-input');
          if(!input) return;
          var modal = input.closest('.confirm-delete-modal');
          if(!modal) return;
          var must = (modal.getAttribute('data-confirm-text')||'').trim();
          var btn = modal.querySelector('.confirm-delete-submit');
          if(!btn) return;
          var val = (input.value||'').trim();
          btn.disabled = (val !== must);
        });
        document.addEventListener('click', function(e){
          var btn = e.target.closest && e.target.closest('.confirm-delete-submit');
          if(!btn) return;
          var modal = btn.closest('.confirm-delete-modal');
          if(!modal) return;
          var action = modal.getAttribute('data-action');
          var method = (modal.getAttribute('data-method')||'DELETE').toUpperCase();
          if(!action) return;
          var old = btn.textContent; btn.disabled = true; btn.textContent = 'Eliminating...';
          var opts = { method: method, credentials: 'include' };
          fetch(action, opts).then(function(res){
            if(!res.ok) return res.json().catch(function(){ return {}; }).then(function(d){ throw new Error(d.message || (d.error && (d.error.message || d.error.code)) || 'Error'); });
            return res.json().catch(function(){ return {}; });
          }).then(function(){
            if (window.showAdminToast) showAdminToast('Deleted', 'success');
            try {
              var sel = modal.getAttribute('data-remove-selector');
              if (sel) { var el = document.querySelector(sel); if (el) el.remove(); }
              if (window.bootstrap && bootstrap.Modal) bootstrap.Modal.getOrCreateInstance(modal).hide();
            } catch(_){ }
          }).catch(function(err){ console.error(err); if (window.showAdminToast) showAdminToast(err && err.message || 'Could not delete', 'danger'); })
          .finally(function(){ btn.disabled = false; btn.textContent = old; });
        });
      })();
    // Toast helper
    script.
      (function(){
        window.showAdminToast = function(message, type){
          try {
            var container = document.getElementById('admin-toast-container');
            if (!container) return alert(message);
            var toastEl = document.createElement('div');
            var level = type === 'danger' ? 'text-bg-danger' : (type === 'warning' ? 'text-bg-warning' : 'text-bg-success');
            toastEl.className = 'toast align-items-center ' + level + ' border-0';
            toastEl.setAttribute('role','alert');
            toastEl.setAttribute('aria-live','assertive');
            toastEl.setAttribute('aria-atomic','true');
            toastEl.innerHTML = "<div class='d-flex'><div class='toast-body'></div><button type='button' class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast' aria-label='Close'></button></div>";
            toastEl.querySelector('.toast-body').textContent = message;
            container.appendChild(toastEl);
            if (window.bootstrap && bootstrap.Toast) {
              var t = new bootstrap.Toast(toastEl, { delay: 2500 });
              t.show();
            } else {
              toastEl.style.display = 'block';
              setTimeout(function(){ toastEl.remove(); }, 2500);
            }
          } catch (e) { try { alert(message); } catch(_){} }
        };
      })();
    // Reset password trigger for admin tables
    script.
      (function(){
        function onClick(e){
          var btn = e.target.closest && e.target.closest('.admin-reset-pass');
          if(!btn) return;
          e.preventDefault();
          var id = btn.getAttribute('data-user-id');
          if(!id) return;
          if(!confirm('Reset password for this user?')) return;
          var old = btn.textContent;
          btn.disabled = true; btn.classList.add('disabled'); btn.textContent = 'Reseteando...';
          var done = function(){ btn.disabled=false; btn.classList.remove('disabled'); btn.textContent = old; };
          var url = '/api/v1/users/' + encodeURIComponent(id) + '/reset-password';
          var success = function(){
            if (window.showAdminToast) showAdminToast('Password reset.','success');
            var modalEl = btn.closest && btn.closest('.modal');
            if (modalEl && window.bootstrap && bootstrap.Modal) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
          };
          var failure = function(){ if (window.showAdminToast) showAdminToast('No se pudo resetear.','danger'); };
          if (window.axios) {
            axios.patch(url).then(function(){ success(); }).catch(function(err){ console.error(err); failure(); }).finally(done);
          } else {
            fetch(url, { method: 'PATCH' }).then(function(res){ if(!res.ok) throw new Error('Failed'); success(); }).catch(function(err){ console.error(err); failure(); }).finally(done);
          }
        }
        function onSaveRoles(e){
          var btn = e.target.closest && e.target.closest('.admin-save-roles');
          if(!btn) return;
          e.preventDefault();
          var id = btn.getAttribute('data-user-id');
          var modalEl = btn.closest && btn.closest('.modal');
          if(!id || !modalEl) return;
          var checkboxes = modalEl.querySelectorAll && modalEl.querySelectorAll('[data-role-checkbox]');
          var roles = Array.prototype.filter.call(checkboxes || [], function(cb){ return cb.checked; }).map(function(cb){ return cb.value; });
          if(!roles.length){
            var msg = 'Selecciona al menos un rol.';
            if (window.showAdminToast) showAdminToast(msg, 'warning'); else alert(msg);
            return;
          }
          if(!confirm('Save selected roles for this user?')) return;
          var old = btn.textContent;
          btn.disabled = true; btn.classList.add('disabled'); btn.textContent = 'Saving...';
          var done = function(){ btn.disabled=false; btn.classList.remove('disabled'); btn.textContent = old; };
          var url = '/api/v1/users/' + encodeURIComponent(id) + '/role';
          var success = function(){
            if (window.showAdminToast) showAdminToast('Roles updated', 'success');
            if (modalEl && window.bootstrap && bootstrap.Modal) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
          };
          var failure = function(){ if (window.showAdminToast) showAdminToast('Could not update roles','danger'); };
          var payload = { roles: roles };
          if (window.axios) {
            axios.patch(url, payload).then(function(){ success(); }).catch(function(err){ console.error(err); failure(); }).finally(done);
          } else {
            fetch(url, { method: 'PATCH', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) })
              .then(function(res){ if(!res.ok) throw new Error('Failed'); success(); })
              .catch(function(err){ console.error(err); failure(); })
              .finally(done);
          }
        }
        document.addEventListener('click', onClick);
        document.addEventListener('click', onSaveRoles);
      })();
    // Toggle active/inactive user (admin)
    script.
      (function(){
        function onToggle(e){
          var btn = e.target.closest && e.target.closest('.admin-toggle-active');
          if(!btn) return;
          e.preventDefault();
          var id = btn.getAttribute('data-user-id');
          var action = btn.getAttribute('data-action'); // 'deactivate' | 'reactivate'
          if(!id || !action) return;
          var confirmMsg = action === 'deactivate' ?'Deactivate this account?': 'Reactivate this account?';
          if(!confirm(confirmMsg)) return;
          var old = btn.textContent;
          btn.disabled = true; btn.classList.add('disabled'); btn.textContent = 'Updating...';
          var done = function(){ btn.disabled=false; btn.classList.remove('disabled'); btn.textContent = old; };
          var url = '/api/v1/users/' + encodeURIComponent(id) + '/' + (action === 'deactivate' ? 'deactivate' : 'reactivate');
          var success = function(){
            if (window.showAdminToast) showAdminToast('Updated status','success');
            var modalEl = btn.closest && btn.closest('.modal');
            if (modalEl && window.bootstrap && bootstrap.Modal) bootstrap.Modal.getOrCreateInstance(modalEl).hide();
            var row = btn.closest && btn.closest('tr');
            var badge = row && row.querySelector && row.querySelector('td:nth-child(3) .badge');
            var isDeactivate = action === 'deactivate';
            if (badge) {
              badge.classList.remove('text-bg-success','text-bg-secondary');
              badge.classList.add(isDeactivate ? 'text-bg-secondary' : 'text-bg-success');
              badge.textContent = isDeactivate ? 'Idle' : 'Asset';
            }
            if (isDeactivate) {
              btn.setAttribute('data-action','reactivate');
              btn.classList.remove('btn-outline-secondary');
              btn.classList.add('btn-success');
              btn.innerText = 'Reactivate account';
            } else {
              btn.setAttribute('data-action','deactivate');
              btn.classList.remove('btn-success');
              btn.classList.add('btn-outline-secondary');
              btn.innerText = 'Deactivate account';
            }
          };
          var failure = function(){ if (window.showAdminToast) showAdminToast('Could not update status','danger');};
          if (window.axios) {
            axios.patch(url).then(function(){ success(); }).catch(function(err){ console.error(err); failure(); }).finally(done);
          } else {
            fetch(url, { method: 'PATCH' }).then(function(res){ if(!res.ok) throw new Error('Failed'); success(); }).catch(function(err){ console.error(err); failure(); }).finally(done);
          }
        }
        document.addEventListener('click', onToggle);
      })();






