//- views/layouts/public.pug
doctype html
html.no-js(lang='es')
  head
    title #{title || 'Galería del Ox'}
    meta(charset='utf-8')
    meta(http-equiv='X-UA-Compatible' content='IE=edge,chrome=1')
    meta(name='viewport' content='width=device-width, initial-scale=1')

    //- CSS de Bootstrap y tus estilos
 
    link(rel='preconnect' href='https://fonts.googleapis.com')
    link(rel='preconnect' href='https://fonts.gstatic.com' crossorigin)
    //- Preconnect al CDN de imágenes (Cloudinary)
    link(rel='preconnect' href='https://res.cloudinary.com')
    //- Fonts: add Montserrat for artwork cards
    link(rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Newsreader:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Montserrat:wght@400;500;600;700&display=swap')
    link(rel='stylesheet' href='/bootstrap/css/bootstrap.min.css')
    link(rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css')
    link(rel='stylesheet' href='/css/component.css')
    link(rel='stylesheet' href='/css/style.css')
    style.
      /* Overlay de carga global estilos */
      .page-loading-overlay { position: fixed; inset: 0; background: #ffffff; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; transition: opacity 200ms ease, visibility 200ms ease; }
      .page-loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
      .loading-spinner { width: 48px; height: 48px; border-radius: 50%; border: 4px solid #e5e7eb; border-top-color: #5022c3; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .loading-text { color: #555; font-weight: 600; }
      /* Evitar FOUC: ocultar contenido principal y evitar scroll mientras carga */
      body.loading { overflow: hidden; }
      body.loading .main-content { visibility: hidden; }
    script(src='/js/modernizr.custom.js')
    //- Cargar axios y shim temprano para que inline scripts lo usen
    script(src='https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js')
    script(src='/js/http.js')

    //- Permite que las vistas inyecten CSS/JS extra en <head>
    block headExtra

  body(class=hideGlobalOverlay ? '' : 'loading')
    // Overlay de carga global (opcional)
    if !hideGlobalOverlay
      #page-loading-overlay.page-loading-overlay
        .loading-spinner
        .loading-text Cargando…
    if !hideNavbar
      //- Navbar: Expande a partir de lg (colapsa < 992px)
      nav.navbar.navbar-expand-xxl.main-navbar(aria-label='Navbar principal')
        .container-fluid.navbar-container
          //- Brand (logo + título) — queda a la izquierda
          a.navbar-brand.d-flex.align-items-center.navbar-logo-link(href='/')
            img.logo-navbar(src='/Logos/GOX_LOGO_06.png' alt='Galería del Ox')
            h1.ms-1.text-uppercase.fw-bold.navbar-title Galería del Ox

          //- Botón hamburguesa
          button.navbar-toggler(
            type='button'
            data-bs-toggle='collapse'
            data-bs-target='#navbarsExample05'
            aria-controls='navbarsExample05'
            aria-expanded='false'
            aria-label='Abrir menú')
            span.navbar-toggler-icon

          //- Contenido colapsable
          //- Nota: en mobile el contenido se centra; en lg+ el ul usa ms-lg-auto para irse a la derecha
          .collapse.navbar-collapse#navbarsExample05.text-center
            //- Buscador — centrado en mobile, centrado entre brand y links en desktop
            form.d-flex.flex-grow-1.flex-lg-grow-0.mx-auto.mx-lg-auto.my-3.my-lg-0(action='/search' method='GET' role='search' aria-label='Buscar')
              input.form-control.searchbar-input(type='search', name='q', placeholder='Buscar', aria-label='Buscar')

            //- Links principales — al extremo derecho en lg+ con ms-lg-auto; centrados en mobile
            ul.navbar-nav.navbar-links.ms-lg-auto.mx-auto.mb-2.mb-lg-0.fs-5
              li.nav-item
                a.nav-link.me-lg-3(href='/artworks') Obras
              li.nav-item
                a.nav-link.me-lg-3(href='/artists') Artistas
              li.nav-item
                a.nav-link.me-lg-3(href='/exhibitions') Exposiciones

              if !currentUser
                li.nav-item
                  a.nav-link(href='/login' aria-label='Iniciar sesión') Iniciar sesión
                li.nav-item
                  a.nav-link.nav-link-registrarse(href='/signup' aria-label='Registrarse') Registrarse
              else
                li.nav-item.dropdown
                  a.nav-link.dropdown-toggle.nav-username#userMenu(
                    href='#'
                    role='button'
                    data-bs-toggle='dropdown'
                    aria-expanded='false'
                    aria-label='Menú de usuario')= currentUser.name
                  ul.dropdown-menu.dropdown-menu-end(aria-labelledby='userMenu')
                    li
                      a.dropdown-item.mb-2(href='/edit-profile' aria-label='Editar cuenta') Editar cuenta
                    if currentUser && currentUser.role !== 'artist'
                      li
                        a.dropdown-item.mb-2(href='/become-artist' aria-label='Vender mi arte') Vender mi arte
                    if currentUser && currentUser.role === 'artist'
                      li
                        a.dropdown-item.mb-2(href='/artists/panel' aria-label='Panel de artista') Panel de artista
                    if currentUser && currentUser.role === 'admin'
                      li
                        a.dropdown-item.mb-2(href='/admin' aria-label='Panel de administrador') Panel de administrador
                    li
                      hr.dropdown-divider.my-2
                    li
                      form(action='/api/v1/auth/logout' method='POST')
                        button.dropdown-item(type='submit' aria-label='Cerrar sesión') Cerrar sesión

    .main-content
      block content

    if !hideFooter
      include ./footer.pug

    //- JS al final del body (orden importante)
    script(src='/bootstrap/js/bootstrap.bundle.min.js')
    script(src='/js/masonry.pkgd.min.js')
    script(src='/js/imagesloaded.js')
    script(src='/js/classie.js')
    script(src='/js/AnimOnScroll.js')

    //- Permite que vistas inyecten JS (por ejemplo, inicializaciones específicas) ANTES de main.js
    block scriptsExtra
    
    if !hideGlobalOverlay
      //- Overlay global: estilos y lógica para ocultarlo cuando
      //- cargan imágenes clave (grids) o cuando termina el load
      script.
        (function(){
          function hideOverlay(){
          function hideOverlay(){
            try {
              var ov = document.getElementById('page-loading-overlay');
              try { document.body.classList.remove('loading'); } catch(_) {}
              if (!ov) return;
              if (!ov.classList.contains('hidden')) ov.classList.add('hidden');
              setTimeout(function(){
          function hideOverlay(){ if (ov && ov.parentNode) try{ ov.remove(); }catch(_){} }, 400);
            } catch(_) {}
          }
          function waitForImportantImages(){
            // Espera a grillas de obras si existen
            var grids = document.querySelectorAll('.artwork-grid');
            var pending = 0;
            function done(){ if (--pending <= 0) hideOverlay(); }
            if (grids && grids.length && typeof window.imagesLoaded === 'function') {
              pending = grids.length;
              for (var i=0;i<grids.length;i++) {
                try { window.imagesLoaded(grids[i], done); } catch(_) { done(); }
              }
            } else if (grids && grids.length) {
              // Sin imagesLoaded, esperar a onload de cada img en cada grid
              var imgs = document.querySelectorAll('.artwork-grid img');
              if (!imgs.length) return hideOverlay();
              pending = imgs.length;
              imgs.forEach(function(img){
                if (img.complete) done();
                else { img.addEventListener('load', done, { once: true }); img.addEventListener('error', done, { once: true }); }
              });
            } else {
              // Si no hay grids, usar fallback por tiempo y window load
              setTimeout(hideOverlay, 600);
            }
            // Fallbacks generales
            setTimeout(hideOverlay, 3000);
            window.addEventListener('load', hideOverlay, { once: true });
          }
          if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', waitForImportantImages);
          else waitForImportantImages();
        })();
    
    script(src='/js/masonry-init.js')
    if !hideGlobalOverlay
      //- Refuerzo: cerrar overlay cuando Masonry avise readiness (y con fallback)
      script.
        (function(){
          function clearOverlay(){
            try {
              var ov = document.getElementById('page-loading-overlay');
              try { document.body.classList.remove('loading'); } catch(_) {}
              if (!ov) return;
              if (!ov.classList.contains('hidden')) ov.classList.add('hidden');
              setTimeout(function(){ if (ov && ov.parentNode) try{ ov.remove(); }catch(_){} }, 300);
            } catch(_) {}
          }
          function bind(){
            var grids = document.querySelectorAll('.artwork-grid');
            if (!grids || !grids.length) { setTimeout(clearOverlay, 400); return; }
            var left = grids.length;
            function done(){ if (--left <= 0) clearOverlay(); }
            for (var i=0;i<grids.length;i++) {
              var g = grids[i];
              if (g.classList && g.classList.contains('is-ready')) { done(); continue; }
              try { g.addEventListener('ox:masonry:ready', done, { once: true }); } catch(_) { setTimeout(done, 600); }
            }
            setTimeout(clearOverlay, 2200);
          }
          if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind);
          else bind();
          window.addEventListener('load', clearOverlay, { once: true });
        })();

    //- Tu JS global
    script(src='/js/main.js')
    //- Región aria-live para confirmaciones accesibles
    #sr-live.visually-hidden(aria-live='polite' aria-atomic='true')


