extends /layouts/public

block content
  main.main-content.artist-detail-page
    // Hero Section
    section.artist-profile-hero.artist-hero-section.position-relative.artist-hero-fullscreen
      .hero-background.artist-hero-bg.position-absolute.w-100.h-100
        if artist.profileImage
          img.hero-bg-image.artist-bg-image.w-100.h-100.artist-image-cover(
            src=artist.profileImage, 
            alt=artist.name
          )
        else
          .hero-bg-placeholder.artist-bg-placeholder.w-100.h-100.artist-gradient-bg
      .hero-overlay.artist-hero-overlay.position-absolute.w-100.h-100.exhibition-hero-overlay
      .hero-content.artist-hero-content.position-absolute.bottom-0.start-0.w-100.artist-hero-z-index
        .container
          .row
            .col-12.col-lg-8
              .artist-hero-info.artist-info-desktop.text-white.pb-5.artist-hero-card.p-4.p-lg-5
                h1.hero-title.artist-name-desktop.display-2.fw-bold.mb-3.artist-title-font.artist-text-shadow= artist.name
                if stats && stats.techniques && stats.techniques.length
                  .artist-techniques-inline.d-flex.flex-wrap.align-items-center.gap-3.mb-4
                    span.artist-techniques-heading.text-white-75.text-uppercase.small.fw-semibold Tecnicas
                    .artist-techniques-tags.d-flex.flex-wrap.align-items-center.gap-2
                      each technique in stats.techniques.slice(0, 10)
                        - var normalizedTechnique = technique ? technique.toString().trim() : ''
                        - normalizedTechnique = normalizedTechnique ? normalizedTechnique.charAt(0).toUpperCase() + normalizedTechnique.slice(1).toLowerCase() : ''
                        if normalizedTechnique
                          span.small.text-warning.fw-bold.artist-technique-tag= normalizedTechnique
                    if stats.techniques.length > 10
                      span.small.text-white-50.artist-techniques-more +#{stats.techniques.length - 10} mas
                if artist.createdAt
                  h2.hero-subtitle.artist-member-since.h4.mb-4.text-white-50.artist-subtitle-font.artist-text-shadow-light= `Miembro desde ${new Date(artist.createdAt).getFullYear()}`
                if artist.bio
                  p.hero-bio.artist-bio-desktop.lead.mb-4.text-white-75.artist-bio-style= artist.bio
                .hero-meta.artist-meta-desktop.d-flex.flex-wrap.gap-4.mb-4
                  if artist.location
                    .meta-item.artist-location-item.d-flex.align-items-center
                      i.fas.fa-map-marker-alt.me-2.text-warning
                      span.text-white-75= artist.location
                  if artist.website
                    .meta-item.artist-website-item
                      a.text-warning.text-decoration-none(href=artist.website, target="_blank", rel="noopener")
                        i.fas.fa-globe.me-2
                        span Sitio web
                  if artist.social && artist.social.instagram
                    .meta-item.artist-social-instagram
                      a.text-warning.text-decoration-none(href=`https://instagram.com/${artist.social.instagram}`, target="_blank", rel="noopener")
                        i.fab.fa-instagram.me-2
                        span Instagram
                  if artist.social && artist.social.x
                    .meta-item.artist-social-x
                      a.text-warning.text-decoration-none(href=`https://x.com/${artist.social.x}`, target="_blank", rel="noopener")
                        i.fab.fa-x.me-2
                  if artist.social && artist.social.facebook
                    .meta-item.artist-social-facebook
                      a.text-warning.text-decoration-none(href=`https://facebook.com/${artist.social.facebook}`, target="_blank", rel="noopener")
                        i.fab.fa-facebook.me-2
                        span Facebook
                .hero-actions.artist-actions-desktop.d-flex.gap-3
                  // Botón Seguir/Siguiendo
                  - var following = typeof isFollowing !== 'undefined' ? isFollowing : false;
                  button.btn.btn-outline-light.btn-lg.px-4.artist-follow-btn.artist-action-btn(type="button" data-artist-id=artist._id aria-pressed=following ? 'true' : 'false' class= following ? 'active' : '')
                    i.fas.fa-heart.me-2
                    | #{following ? 'Siguiendo' : 'Seguir'}
                  button.btn.btn-outline-light.btn-lg.px-4.artist-share-btn.artist-action-btn
                    i.fas.fa-share.me-2
                    | Compartir

    // Obras del artista
    if artworks && artworks.length > 0
      section.artist-artworks.artist-artworks-section.py-5.artist-artworks-bg
        .container
          .row.mb-5
            .col-12.text-center
              h2.section-title.artist-artworks-title.display-5.fw-bold.mb-3.artist-section-title= `Obras de ${artist.name}`
              - var displayText = artworks.length === totalArtworks ? `${totalArtworks} obra${totalArtworks === 1 ? '' : 's'}` : `Mostrando ${artworks.length} de ${totalArtworks} obras`
              p.lead.text-muted.artist-artworks-subtitle= `${displayText} de este talentoso artista`
        if totalArtworks > 1
          section.filters-toolbar.artist-filters-section.py-2
            .container-xxl.d-flex.align-items-center.flex-wrap.gap-2.artist-container-padding
              - var q = typeof q !== 'undefined' ? q : {};
              - var techniques = typeof techniques !== 'undefined' ? techniques : [];
              - var priceBounds = typeof priceBounds !== 'undefined' ? priceBounds : {};
              - var appliedPrice = typeof appliedPrice !== 'undefined' ? appliedPrice : {};
              - var actionUrl = `/artists/${artist.slug || artist._id}`;
              include /public/artworks/_artworkFilters.pug
        .container-xxl.artworks-flex.artist-artworks-grid.artist-container-padding
          if artworks && artworks.length
            .artworks-grid-paginate.artist-artworks-paginate
              - var backTo = typeof currentPath !== 'undefined' ? currentPath : ''
              include /public/artworks/_artworkGrid.pug
              include /public/artworks/_artworkPagination.pug
          else
            h3.h5.mt-4.text-muted.artist-no-filtered-artworks No se encontraron obras con estos filtros.
    else
      section.no-artworks.artist-no-artworks-section.py-5.text-center
        .container
          h2.section-title.artist-no-artworks-title.display-5.fw-bold.mb-3.artist-section-title= `Obras de ${artist.name}`
          if stats.totalArtworks > 1
            section.filters-toolbar.artist-no-artworks-filters.py-2.mb-4
              .container-xxl.d-flex.align-items-center.flex-wrap.gap-2.artist-container-padding
                - var q = typeof q !== 'undefined' ? q : {};
                - var techniques = typeof techniques !== 'undefined' ? techniques : [];
                - var priceBounds = typeof priceBounds !== 'undefined' ? priceBounds : {};
                - var appliedPrice = typeof appliedPrice !== 'undefined' ? appliedPrice : {};
                - var actionUrl = `/artists/${artist.slug || artist._id}`;
                include /public/artworks/_artworkFilters.pug
          .row.justify-content-center
            .col-lg-6
              i.fas.fa-palette.fa-4x.text-muted.mb-4.artist-no-artworks-icon
              if stats.totalArtworks > 1
                h3.h4.mb-3.text-muted.artist-filtered-message No se encontraron obras con estos filtros
                p.text-muted.artist-filter-help Prueba ajustar los filtros o
                  |  
                  a(href=actionUrl) limpiar todos los filtros
                  |  para ver todas las obras de #{artist.name}
              else if stats.totalArtworks === 1
                h3.h4.mb-3.text-muted.artist-single-work= `${artist.name} tiene una obra publicada`
                p.text-muted.artist-single-work-message Esta es la A�nica obra disponible de este talentoso artista. A�Vuelve pronto para ver mA�s creaciones!
              else
                h3.h4.mb-3.text-muted.artist-no-published-works= `${artist.name} aA�n no tiene obras publicadas`
                p.text-muted.artist-portfolio-message Este artista estA� preparando su portfolio. A�Vuelve pronto para ver sus creaciones!

    // Botón de volver
  section.back-navigation.py-4
    .container
      .row
        .col-12.text-center
          a.btn.btn-outline-primary.btn-lg.artist-back-btn.ox-back-btn(href="/artists" aria-label="Volver")
            i.fas.fa-arrow-left.me-2
            | Volver

  // Inline script para manejar seguir/dejar de seguir
  script.
    (function(){
      function toggleFollow(artistId, desired){
        var useAxios = typeof window.axios !== 'undefined';
        if (desired) {
          if (useAxios) return axios.post('/api/v1/follows', { artistId }).then(function(){ return { ok: true, following: true }; }).catch(function(e){ return { ok: false, error: e }; });
          return fetch('/api/v1/follows', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', body: JSON.stringify({ artistId: artistId }) })
            .then(function(res){ if (!res.ok && res.status !== 200 && res.status !== 201) throw res; return { ok: true, following: true }; })
            .catch(function(e){ return { ok: false, error: e }; });
        } else {
          if (useAxios) return axios.delete('/api/v1/follows/' + artistId).then(function(){ return { ok: true, following: false }; }).catch(function(e){ return { ok: false, error: e }; });
          return fetch('/api/v1/follows/' + artistId, { method: 'DELETE', credentials: 'same-origin' })
            .then(function(res){ if (!res.ok && res.status !== 204 && res.status !== 404) throw res; return { ok: true, following: false }; })
            .catch(function(e){ return { ok: false, error: e }; });
        }
      }
      function setup(){
        var btns = document.querySelectorAll('.artist-follow-btn, .artist-follow-btn-mobile');
        if (!btns || !btns.length) return;
        btns.forEach(function(btn){
          var artistId = btn.getAttribute('data-artist-id');
          if (!artistId) return;
          function getState(){ return btn.getAttribute('aria-pressed') === 'true'; }
          function setState(following){
            btn.setAttribute('aria-pressed', following ? 'true' : 'false');
            btn.classList.toggle('active', !!following);
            var label = following ? 'Siguiendo' : 'Seguir';
            // rebuild content to keep icon
            btn.innerHTML = '<i class="fas fa-heart me-2"></i>' + label;
          }
          btn.addEventListener('click', function(e){
            if (btn.disabled) return;
            // Visual click effects: ripple + pop
            try {
              var rect = btn.getBoundingClientRect();
              var size = Math.max(rect.width, rect.height);
              var x = (e.clientX - rect.left) - size / 2;
              var y = (e.clientY - rect.top) - size / 2;
              var ripple = document.createElement('span');
              ripple.className = 'btn-ripple';
              ripple.style.width = size + 'px';
              ripple.style.height = size + 'px';
              ripple.style.left = x + 'px';
              ripple.style.top = y + 'px';
              btn.appendChild(ripple);
              ripple.addEventListener('animationend', function(){ ripple.remove(); });
              btn.classList.add('btn-pop');
              btn.addEventListener('animationend', function handler(){ btn.classList.remove('btn-pop'); btn.removeEventListener('animationend', handler); });
            } catch(_) {}
            var desired = !getState();
            btn.disabled = true; btn.classList.add('disabled');
            Promise.resolve(toggleFollow(artistId, desired)).then(function(res){
              btn.disabled = false; btn.classList.remove('disabled');
              if (res && res.ok) {
                setState(!!res.following);
              } else {
                var status = (res && res.error && (res.error.status || (res.error.response && res.error.response.status))) || 0;
                if (status === 401 || status === 403) {
                  var returnTo = window.location.pathname + window.location.search;
                  window.location.assign('/login?returnTo=' + encodeURIComponent(returnTo));
                } else {
                  console.error('No se pudo actualizar seguimiento', res && res.error);
                }
              }
            });
          });
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setup);
      } else { setup(); }
    })();
