extends /layouts/public

block content
  - var dateText = '';
  - var visibleArtistIds = Array.isArray(artworks) ? artworks.map(function(a){ try { return String(a && a.artist && a.artist._id); } catch(e) { return null; } }).filter(Boolean) : [];
  - var guestArtists = Array.isArray(exhibition && exhibition.participants) ? exhibition.participants.filter(function(p){
  -   try {
  -     var roleOk = p && p.role && ['artista','invitado'].includes(String(p.role).toLowerCase());
  -     var uid = p && p.user && (p.user._id || p.user);
  -     return roleOk && uid && visibleArtistIds.includes(String(uid)) && p.user && p.user.name;
  -   } catch(e) { return false; }
  - }) : [];

  main.main-content.exhibition-detail-page
    section.exhibition-hero.position-relative.exhibition-hero-fullscreen.exhibition-detail__hero
      .hero-background.exhibition-hero-bg.position-absolute.w-100.h-100
        if exhibition && exhibition.coverImage
          img.exhibition-hero-bg-custom.exhibition-detail__hero-img(
            src=exhibition.coverImage,
            alt=(exhibition.title || exhibition.name || 'Exposición')
          )
        else
          .hero-bg-placeholder.w-100.h-100.exhibition-gradient-bg.exhibition-detail__hero-placeholder

      .exhibition-hero-overlay-custom.exhibition-detail__hero-overlay

      .hero-content.exhibition-hero-content.position-absolute.bottom-0.start-0.w-100.exhibition-hero-z-index.exhibition-detail__hero-content
        .container.text-white.pb-5.exhibition-detail__hero-container
          .row.exhibition-detail__hero-row
            .col-12.col-lg-10.col-xl-8
              // Card unificado: título, descripción, fechas, lugar y artistas invitados
              .exhibition-hero-info.text-white.pb-4.pb-lg-5.exhibition-hero-card.p-4.p-lg-5
                // Título y descripción
                h1.display-4.fw-bold.mb-3.exhibition-title-font.exhibition-detail__title= title
                if exhibition && exhibition.description
                  p.lead.mb-4.text-white-75.exhibition-description-style.exhibition-detail__description= exhibition.description

                hr.my-3.opacity-50

                // Fechas y lugar en dos columnas en desktop
                .row.g-4
                  .col-12.col-lg-6
                    .small.text-white-75.mb-2 Fechas
                    - try {
                    -   var hasStart = exhibition && exhibition.startDate;
                    -   var hasEnd = exhibition && exhibition.endDate;
                    -   if (hasStart || hasEnd) {
                    -     var sD = hasStart ? new Date(exhibition.startDate) : null;
                    -     var eD = hasEnd ? new Date(exhibition.endDate) : null;
                    -     var sd = hasStart ? sD.getDate() : null;
                    -     var ed = hasEnd ? eD.getDate() : null;
                    -     var sMonthShort = hasStart ? sD.toLocaleDateString('es-MX', { month: 'short' }) : '';
                    -     var eMonthShort = hasEnd ? eD.toLocaleDateString('es-MX', { month: 'short' }) : '';
                    -     var sy = hasStart ? sD.getFullYear() : null;
                    -     var ey = hasEnd ? eD.getFullYear() : null;
                    -     if (hasStart && hasEnd) {
                    -       var sameYear = sy === ey;
                    -       var sameMonth = sameYear && (sD.getMonth() === eD.getMonth());
                    -       if (sameYear && sameMonth) {
                    -         dateText = `${sd}–${ed} ${sMonthShort} ${sy}`;
                    -       } else if (sameYear) {
                    -         dateText = `${sd} ${sMonthShort} – ${ed} ${eMonthShort} ${sy}`;
                    -       } else {
                    -         dateText = `${sd} ${sMonthShort} ${sy} – ${ed} ${eMonthShort} ${ey}`;
                    -       }
                    -     } else if (hasStart) {
                    -       dateText = `Desde ${sd} ${sMonthShort} ${sy}`;
                    -     } else if (hasEnd) {
                    -       dateText = `Hasta ${ed} ${eMonthShort} ${ey}`;
                    -     }
                    -   }
                    - } catch(e) { }
                    if dateText
                      .h6.mb-0= dateText
                    else
                      .small.text-white-50 Por anunciar
                  .col-12.col-lg-6
                    .small.text-white-75.mb-2 Lugar
                    if exhibition && exhibition.location && exhibition.location.type === 'physical'
                      .h6.mb-0= exhibition.venue || exhibition.location.address || 'Por anunciar'
                    else if exhibition && exhibition.location && exhibition.location.type === 'virtual'
                      .h6.mb-0.exhibition-detail__venue
                        span.text-white Exposición virtual
                    else
                      .small.text-white-50 Por anunciar

                if guestArtists && guestArtists.length
                  hr.my-3.opacity-50
                  .small.text-white-75.mb-2.exhibition-detail__guests-label Artistas invitados
                  ul.list-unstyled.mb-0.exhibition-detail__guests-list
                    each p in guestArtists
                      li.text-white-75.exhibition-detail__guest-item
                        if p.user && p.user._id
                          // Enlazar por ID para redirigir al slug vigente
                          a.text-decoration-none.exhibition-artist-link.exhibition-detail__guest-link(href=`/artists/${p.user._id}`)= p.user.name
                        else
                          span.exhibition-detail__guest-name #{p.user && p.user.name}

    section.exhibition-mobile.d-lg-none.py-5.exhibition-mobile-bg
      .container
        .row
          .col-12.text-center
            h1.display-4.fw-bold.mb-2.exhibition-mobile-title= title
            if dateText
              h2.h5.mb-3.text-muted.exhibition-mobile-date= dateText
            if exhibition && exhibition.description
              p.lead.mb-0.text-dark.exhibition-mobile-description= exhibition.description

    if artworks && artworks.length > 0
      section.exhibition-artworks.py-5.exhibition-artworks-bg
        .container
          .row.mb-5
            .col-12.text-center
              h2.section-title.display-5.fw-bold.mb-3.artist-section-title Obras en esta exposición
              - var displayText = (typeof totalArtworks !== 'undefined' && typeof artworks !== 'undefined') ? (artworks.length === totalArtworks ? `${totalArtworks} obra${totalArtworks === 1 ? '' : 's'}` : `Mostrando ${artworks.length} de ${totalArtworks} obras`) : `${artworks.length} obra${artworks.length === 1 ? '' : 's'}`
              p.lead.text-muted= displayText
        .container-xxl.artworks-flex.artist-container-padding
          .artworks-grid-paginate
            - var gridId = 'grid-exhibition'
            include /public/artworks/_artworkGrid.pug
            if typeof totalPages !== 'undefined' && totalPages > 1
              include /public/artworks/_artworkPagination.pug
    else
      section.no-artworks.py-5.text-center
        .container
          i.fas.fa-images.fa-3x.text-muted.mb-3
          h3.h4.mb-2.text-muted No hay obras asociadas a esta exposición
          p.text-muted Vuelve pronto para descubrir nuevas piezas.

    section.back-navigation.py-4
      .container
        .row
          .col-12.text-center
            a.btn.btn-outline-primary.btn-lg.exhibition-back-btn.ox-back-btn(href="/exhibitions")
              i.fas.fa-arrow-left.me-2
              | Volver
