extends /layouts/public

block headExtra
  style.
    .page-loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.96); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; transition: opacity 200ms ease, visibility 200ms ease; }
    .page-loading-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .loading-spinner { width: 48px; height: 48px; border-radius: 50%; border: 4px solid #e5e7eb; border-top-color: #5022c3; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { color: #555; font-weight: 600; }

block scriptsExtra
  script.
    (function(){
      function hideOverlay(){
        try {
          var ov = document.getElementById('page-loading-overlay');
          if (!ov) return;
          if (!ov.classList.contains('hidden')) ov.classList.add('hidden');
          setTimeout(function(){ if (ov && ov.parentNode) try{ ov.remove(); }catch(_){} }, 400);
        } catch(_) {}
      }
      function waitForGrids(){
        var grids = document.querySelectorAll('.artwork-grid');
        if (!grids || grids.length === 0) { hideOverlay(); return; }
        var remaining = grids.length;
        function done(){ remaining--; if (remaining <= 0) hideOverlay(); }
        for (var i = 0; i < grids.length; i++) {
          var g = grids[i];
          if (typeof window.imagesLoaded === 'function') {
            try { window.imagesLoaded(g, function(){ done(); }); } catch(_) { done(); }
          } else { done(); }
        }
        setTimeout(hideOverlay, 2500);
        window.addEventListener('load', hideOverlay, { once: true });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', waitForGrids);
      else waitForGrids();
    })();

block content
  #page-loading-overlay.page-loading-overlay
    .loading-spinner
    .loading-text Cargando…
  .container.py-4
    // Saludo simple
    .d-flex.align-items-center.mb-4.gap-3
      - const uname = (locals.currentUser && (locals.currentUser.firstName || locals.currentUser.name)) || 'Artista'
      .avatar-circle.d-flex.align-items-center.justify-content-center(style="width:64px;height:64px;border-radius:50%;background:#EEE;color:#555;font-weight:700")
        = uname.charAt(0).toUpperCase()
      .flex-grow-1
        h2.mb-0 Bienvenido de nuevo, #{uname}
        p.text-muted.mb-0 Explora novedades y retoma donde lo dejaste

    // Obras recientes
    section.mb-5
      .d-flex.align-items-center.justify-content-between.mb-2
        h3.mb-0 Obras recientes
        a.btn.btn-sm.btn-outline-secondary(href="/artworks") Ver todo
      if recentWorks && recentWorks.length
        - var artworks = recentWorks.slice(0, 6)
        - var gridId = 'grid-recent'
        include /public/artworks/_artworkGrid.pug
      else
        p.text-muted Aún no hay obras recientes.

    // Populares
    section.mb-5
      .d-flex.align-items-center.justify-content-between.mb-2
        h3.mb-0 Populares esta semana
        a.btn.btn-sm.btn-outline-secondary(href="/artworks?sort=popular") Ver todo
      if popularWorks && popularWorks.length
        - var artworks = popularWorks.slice(0, 6)
        - var gridId = 'grid-popular'
        include /public/artworks/_artworkGrid.pug
      else
        p.text-muted Sin datos populares por ahora.

    // Exposiciones próximas
    section.mb-5
      .d-flex.align-items-center.justify-content-between.mb-2
        h3.mb-0 Próximas exposiciones
        a.btn.btn-sm.btn-outline-secondary(href="/exhibitions") Ver todo
      if upcomingExhibitions && upcomingExhibitions.length
        .row.row-cols-1.row-cols-md-2.row-cols-lg-3.g-3
          each ex in upcomingExhibitions
            .col
              a.card.h-100.text-decoration-none(href=`/exhibitions/${ex.slug || ex._id}`)
                if ex.coverImage
                  img.card-img-top(src=ex.coverImage, alt=ex.title, loading='lazy')
                .card-body
                  h5.card-title.mb-1= ex.title
                  - const sD = ex.startDate ? new Date(ex.startDate) : null
                  - const eD = ex.endDate ? new Date(ex.endDate) : null
                  - const dateText = (sD && eD) ? `Del ${sD.toLocaleDateString('es-ES')} al ${eD.toLocaleDateString('es-ES')}` : (sD ? `Desde ${sD.toLocaleDateString('es-ES')}` : (eD ? `Hasta ${eD.toLocaleDateString('es-ES')}` : ''))
                  if dateText
                    p.card-text.text-muted.mb-0= dateText
      else
        p.text-muted No hay exposiciones próximas.

    // Artistas destacados
    section.mb-4
      .d-flex.align-items-center.justify-content-between.mb-2
        h3.mb-0 Artistas destacados
        a.btn.btn-sm.btn-outline-secondary(href="/artists") Ver todos
      if featuredArtists && featuredArtists.length
        .row.row-cols-2.row-cols-md-4.row-cols-lg-6.g-3
          each a in featuredArtists
            .col
              a.text-decoration-none.d-block.text-center(href=`/artists/${a.slug || a._id}`)
                if a.profileImage
                  img.rounded-circle.mb-2(src=a.profileImage, alt=a.name, loading='lazy', style='width:80px;height:80px;object-fit:cover;')
                else
                  .rounded-circle.mb-2.d-inline-flex.align-items-center.justify-content-center(style='width:80px;height:80px;background:#EEE;color:#666;font-weight:700')= (a.name||'A').charAt(0).toUpperCase()
                div.fw-semibold= a.name
                if typeof a.followersCount !== 'undefined'
                  div.text-muted.small #{a.followersCount} seguidores
      else
        p.text-muted Pronto destacaremos artistas aquí.
