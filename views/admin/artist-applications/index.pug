extends /layouts/admin

block content
  .container.py-5
    h1.h3.mb-4 Solicitudes de artista

    // Filtros de búsqueda
    form.row.gy-2.gx-2.align-items-center.mb-3(method='GET')
      .col-sm-8.col-md-6
        input.form-control(type='text', name='q', placeholder='Buscar por nombre o correo', value=q || '')
      .col-sm-6.col-md-3
        select.form-select(name='status')
          option(value='') Estado: Todos
          option(value='pending' selected=status === 'pending') Pendiente
          option(value='under_review' selected=status === 'under_review') En revisión
          option(value='approved' selected=status === 'approved') Aprobada
          option(value='rejected' selected=status === 'rejected') Rechazada
      .col-sm-6.col-md-3
        select.form-select(name='sort')
          option(value='recent' selected=!sort || sort === 'recent') Recientes primero
          option(value='oldest' selected=sort === 'oldest') Antiguas primero
      .col-auto
        button.btn.btn-primary(type='submit') Buscar
      if q || status || (sort && sort !== 'recent')
        .col-auto
          a.btn.btn-outline-secondary(href='?') Limpiar

    if applications && applications.length
      .table-responsive
        table.table.table-striped.table-hover.align-middle
          thead
            tr
              th Artista
              th Correo
              th Enlaces
              th CV
              th Statement
              th Estado
              th Creada
              th Acciones
          tbody
            each a in applications
              - const u = a.user || {}
              - const badgeCls = a.status === 'approved' ? 'text-bg-success' : (a.status === 'under_review' ? 'text-bg-warning' : (a.status === 'rejected' ? 'text-bg-danger' : 'text-bg-secondary'))
              tr
                td
                  if u && u._id
                    a(href=`/admin/users/${u._id}`)= u.name || '—'
                  else
                    | #{(u && u.name) || '—'}
                td= (u && u.email) || '—'
                td
                  if Array.isArray(a.links) && a.links.length
                    - const showLinks = a.links.slice(0,2)
                    each link in showLinks
                      a.d-inline-block.me-2(target='_blank', rel='noopener', href=link)
                        i.fas.fa-link.me-1
                        | #{link}
                    if a.links.length > 2
                      span.badge.text-bg-light +#{a.links.length - 2}
                  else
                    span.text-muted —
                td
                  a.btn.btn-sm.btn-outline-secondary(href=`/admin/artist-applications/${a._id}/download`)
                    i.fas.fa-file-arrow-down.me-1
                    | Descargar CV
                // Columna Statement (wrap + altura máx + scroll)
                td
                  - const st = String(a.statement || '')
                  if st
                    // En tabla: wrap, altura máxima y scroll dentro de la celda
                    div.text-break(style='max-width: 420px; max-height: 8rem; overflow: auto; white-space: pre-wrap; overflow-wrap: anywhere')= st
                  else
                    span.text-muted —
                td
                  span.badge(class=badgeCls)= a.status
                td= new Date(a.createdAt).toLocaleDateString('es-ES')
                td
                  form.d-flex.gap-2.flex-wrap(action=`/admin/artist-applications/${a._id}/status` method='POST')
                    input(type='hidden', name='redirect', value=`/admin/artist-applications?page=${page}${qsPrefix || ''}`)
                    select.form-select.form-select-sm(name='status')
                      option(value='pending' selected=a.status === 'pending') Pendiente
                      option(value='under_review' selected=a.status === 'under_review') En revisión
                      option(value='approved' selected=a.status === 'approved') Aprobar
                      option(value='rejected' selected=a.status === 'rejected') Rechazar
                    input.form-control.form-control-sm(type='text', name='adminNotes', placeholder='Notas (opcional)', value=a.adminNotes || '')
                    button.btn.btn-sm.btn-outline-primary(type='submit')
                      i.fas.fa-floppy-disk.me-1
                      | Guardar
    else
      .alert.alert-info No hay solicitudes

    if typeof totalPages !== 'undefined' && totalPages > 1
      nav.mt-4(aria-label='Paginación de solicitudes')
        ul.pagination.justify-content-center
          - const prevDisabled = page <= 1
          - const nextDisabled = page >= totalPages
          li.page-item(class=prevDisabled ? 'disabled' : '')
            a.page-link(href=`?page=${page-1}${qsPrefix || ''}` aria-label='Anterior') Anterior
          li.page-item.disabled
            span.page-link= `Página ${page} de ${totalPages}`
          li.page-item(class=nextDisabled ? 'disabled' : '')
            a.page-link(href=`?page=${page+1}${qsPrefix || ''}` aria-label='Siguiente') Siguiente
