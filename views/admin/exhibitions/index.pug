extends /layouts/admin

block content
  .container.py-5
    - const isAdmin = currentUser && currentUser.role === 'admin'
    h1.h3.mb-4.d-flex.justify-content-between.align-items-center
      span Exhibitions
      if isAdmin
        button.btn.btn-success.btn-sm(type='button', data-bs-toggle='modal', data-bs-target='#adminCreateExhibition')
          i.fas.fa-plus.me-1
          | Add exhibition

    // Filtros y busqueda
    form.row.gy-2.gx-2.align-items-center.mb-3(method='GET')
      .col-sm-8.col-md-6
        input.form-control(type='text', name='q', placeholder='Search by title, slug or creator', value=q || '')
      .col-sm-6.col-md-3
        select.form-select(name='when')
          option(value='') Moment: All
          option(value='current' selected=when === 'current') In progress
          option(value='upcoming' selected=when === 'upcoming') Upcoming
          option(value='past' selected=when === 'past') Finished
      .col-sm-6.col-md-3
        select.form-select(name='status')
          option(value='') Status: All
          option(value='draft' selected=statusFilter === 'draft') Eraser
          option(value='published' selected=statusFilter === 'published') Published
          option(value='archived' selected=statusFilter === 'archived') Archived
      .col-sm-6.col-md-3
        select.form-select(name='loc')
          option(value='') Location: All
          option(value='physical' selected=locType === 'physical') Physics
          option(value='virtual' selected=locType === 'virtual') Virtual
      .col-sm-6.col-md-3
        select.form-select(name='sort')
          option(value='recent' selected=!sort || sort === 'recent') Recent first
          option(value='start_asc' selected=sort === 'start_asc') Home: closer
          option(value='start_desc' selected=sort === 'start_desc') Home: further away
          option(value='end_asc' selected=sort === 'end_asc') End: closer
          option(value='end_desc' selected=sort === 'end_desc') End: further away
          option(value='title_asc' selected=sort === 'title_asc') Title A-Z
      .col-auto
        button.btn.btn-primary(type='submit') Search
      if q || when || statusFilter || sort || locType
        .col-auto
          a.btn.btn-outline-secondary(href='?') Clean

    if exhibitions && exhibitions.length
      .table-responsive
        table.table.table-striped.table-hover.align-middle
          thead
            tr
              th title
              th State
              th Created by
              th Location
              th Artworks
              th Start
              th Fin
              th Preview
              th Add works
              th Edit
          tbody
            each e in exhibitions
              - const st = e.status || 'draft'
              - const loc = (e.location && e.location.type) || ''
              tr(id=`exhRow-${e._id}`)
                td= e.title || e.name
                td
                  span.badge(class=st === 'published' ? 'text-bg-success' : (st === 'archived' ? 'text-bg-dark' : 'text-bg-secondary'))= st
                td= e.createdBy && (e.createdBy.name || e.createdBy.email) || '""'
                td= place? (place === 'physical' ? 'Physical' : 'Virtual') : '""'
                td= Array.isArray(e.artworks) ? e.artworks.length : (e.artworksCount || '""')
                td= e.startDate ? new Date(e.startDate).toLocaleDateString('es-ES') : '""'
                td= e.endDate ? new Date(e.endDate).toLocaleDateString('es-ES') : '""'
                // Columna Vista previa
                td
                  a.btn.btn-sm.btn-outline-secondary(href=`/admin/exhibitions/${e._id}` target='_blank')
                    i.fas.fa-eye.me-1
                    | Ver
                // Columna Agregar obras
                td
                  if isAdmin
                    button.btn.btn-sm.btn-outline-success(type='button', data-bs-toggle='modal', data-bs-target=`#adminAddArtworks-${e._id}`)
                      i.fas.fa-plus.me-1
                      | Add
                    include ../modals/_exhibitionAddArtworksModal.pug
                // Columna Editar (modal por fila) + eliminar
                td
                  button.btn.btn-sm.btn-outline-primary(type='button', data-bs-toggle='modal', data-bs-target=`#adminEditExhibition-${e._id}`)
                    i.fas.fa-pen-to-square.me-1
                    | Edit
                  include ../modals/_exhibitionEditModal.pug
                  if isAdmin
                    button.btn.btn-sm.btn-outline-danger.ms-2(type='button', data-bs-toggle='modal', data-bs-target=`#confirmDeleteExhibition-${e._id}`)
                      i.fas.fa-trash-can.me-1
                      | Eliminate
                    - const modalId = `confirmDeleteExhibition-${e._id}`
                    - const modalTitle = `Delete exposure - ${e.title || e.name}`
                    - const modalMessage = 'This action will remove the exposure permanently. Type "DELETE" to confirm.'
                    - const actionUrl = `/api/v1/exhibitions/${e._id}`
                    - const httpMethod = 'DELETE'
                    - const confirmText = 'ELIMINATE'
                    - const confirmBtnLabel = 'Eliminate'
                    - const removeSelector = `#exhRow-${e._id}`
                    include ../modals/_confirmDeleteModal.pug
    else
      .alert.alert-info There are no exhibitions

    if typeof totalPages !== 'undefined' && totalPages > 1
      nav.mt-4(aria-label='Exhibition pagination')
        ul.pagination.justify-content-center
          - const prevDisabled = page <= 1
          - const nextDisabled = page >= totalPages
          li.page-item(class=prevDisabled ? 'disabled' : '')
            a.page-link(href=`?page=${page-1}${qsPrefix || ''}` aria-label='Anterior') Anterior
          li.page-item.disabled
            span.page-link= `Page ${page} the ${totalPages}`
          li.page-item(class=nextDisabled ? 'disabled' : '')
            a.page-link(href=`?page=${page+1}${qsPrefix || ''}` aria-label='Following') Following

    if isAdmin
      include ../modals/_exhibitionCreateModal.pug
